# How to use Testsnet Docker   

## 1. Preparing Images 
### Building images
First of all, you need to change the `login` & `password` (is your token) at file `deploy/testnet/builder/token` to yours. You can get a token from [Here](https://github.com/settings/tokens).

You use this file `deploy/testnet/build_images_for_bootnode_node_explorer.sh` with appropriate params to build images for bootnode, node & explorer.  

```shell script
$ deploy/testnet/build_images_for_bootnode_node_explorer.sh
- Tag Version/Branch Name you want to build: develop   (specific tag or branch you want to build (1.1.2, develop ...))
- Environment of Image: testnet                        (use as a suffix of image tag (testnet, local, ...))
- Do you want to build Explorer Image? y               (build an explorer image or not (y,n))
```



After building successfully, you can check the images by command `docker images`. The result should be like this:
```
REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE
kybernetwork/evrynet-node       develop-testnet     96b4226f096f        6 hours ago         85.2MB
kybernetwork/evrynet-bootnode   develop-testnet     1f48c40245c7        6 hours ago         35.1MB
kybernetwork/evrynet-builder    develop-testnet     b5b539596145        6 hours ago         1.08GB
...
```

### Pushing images to Docker Hub
If you want to reuse built images, you should push them to docker hub. If there is no such requirement, ignore this step.

Make sure you already login to the docker hub by `docker login`.  
Use `docker push <REPOSITORY>:<TAG>` to push the image to Docker Hub.  

Ex:
```
docker push kybernetwork/evrynet-node:develop-testnet
docker push kybernetwork/evrynet-bootnode:develop-testnet
docker push kybernetwork/evrynet-explorer:develop-testnet
```


## 2. Deployment
### 2.1. Using Quickstart With Predefined Config
#### Run Testnet Docker with 3 nodes and the explorer on a single machine

This setup contain a system of 3 Evrynet nodes configured to run Tendermint consensus. The set of addresses for these nodes as well as Tendermint consensus is supposed to be generated by `puppeth`. For a deeper understanding of how to generate this file, please go through [genesis file wiki](https://github.com/Evrynetlabs/evrynet-node/wiki/Genesis-file).  

`deploy/testnet/deploy_bootnode_nodes.sh`  

```shell script
$ deploy/testnet/deploy_bootnode_nodes.sh
- Path of Sharing Volume: /home/ubuntu/testnet/nodes                                            (the path to nodes folder. On Testnet is `/home/ubuntu/testnet/nodes`)
- Path of Genesis File: /home/ubuntu/evrynet-node/deploy/testnet/nodes/bin/genesis.json         (inject genesis file to the image)
- RPC Cors Domain: *                                                                            (allow URL can call API)
- Tag Version/Branch Name you want to deploy: develop                                           (a specific tag or branch you want to build (1.1.2, develop ...)) 
- Environment of Image: testnet                                                                 (use as a suffix of image tag (testnet, local, ...))
```  

To deploy the explorer run this script:   
```
$ deploy/testnet/deploy_explorer.sh
- Tag Version/Branch Name you want to deploy: develop             (specific tag or branch you want to build (1.1.2, develop ...))
- Environment of Image: testnet                                   (use as a suffix of image tag (testnet, local, ...))
```


#### Nodes Information
Nodes data is stored at `deploy/testnet/nodes/data`.  
The data can be cleared using the following script `deploy/testnet/nodes/data/clear_data.sh`

### Webs
- Explorer: http://localhost:8080

#### NOTICE!
- If you want to stop nodes, DON'T USE `docker stop ...`. It can make a crash to DB of nodes => can not run for next time!
- To stop nodes gracefully, USE this file `deploy/testnet/stop_dockers.sh`. It will interact with node in docker to stop gracefully.

---

### 2.2. Setup From Zero 
This guide will demonstrate the process of setting up 3 nodes manually in the same machine. The process will including: 
 - Build the executable from source code
 - Create working directory for the node data
 - Generate node's key (for consensus message signing)
 - Generate enodes address (for node connections)
 - Deploy
 
The bellow example explains how to deploy 3 nodes manually

1. Build and export to `PATH`. Make sure you already have golang 1.12 or later installed.
    ```shell script
    $ go build ./cmd/gev
    $ go build ./cmd/bootnode
    $ go build ./cmd/puppeth
    $ export PATH=$(pwd):$PATH
    ```
2. Move to folder where you want to store nodes data. Creating a working directory for 3 validator nodes  
    ```shell script
    $ mkdir node_1 node_2 node_3
    ```  

3. In each node’s working directory, create a log & data directory called `data`, and inside `data` create the `geth` directory   
    ```shell script
    $ mkdir -p node_1/log
    $ mkdir -p node_2/log
    $ mkdir -p node_3/log
    $ mkdir -p node_1/data/geth
    $ mkdir -p node_2/data/geth
    $ mkdir -p node_3/data/geth
    ```

4. Generate node key and copy it into folder `node_1`, `node_2` `node_3`
    ```shell script
    $ bootnode --genkey=nodekey1
    $ bootnode --genkey=nodekey2
    $ bootnode --genkey=nodekey3
    ```
   
5. Now we will generate initial accounts for any of the nodes in the required node’s working directory. The resulting public account address printed in the terminal should be recorded. Repeat as many times as necessary. A set of funded accounts may be required depending what you are trying to accomplish  
    ```shell script
    $ gev --datadir node_1/data account new
    INFO [06-11|16:05:53.672] Maximum peer count                       ETH=25 LES=0 total=25
    Your new account is locked with a password. Please give a password. Do not forget this password.
    Passphrase: 
    Repeat passphrase: 
    Public address of the key:   0x106674Ec8dc5eAA1fB69A3adD61Da9ADdC78cC34
    Path of the secret key file: nodes/node_1/data/keystore/UTC--2019-11-27T10-54-06.993216000Z--106674ec8dc5eaa1fb69a3add61da9addc78cc34

    $ gev --datadir node_2/data account new
    ...
   
    $ gev --datadir node_3/data account new
    ... 
    ```
  
 6. Now we will get address for 3 nodes. Using the content of nodekey1,2,3 files (Ex: `node_1/data/geth/nodekey`) as Private Key to get Address of each nodes at [myetherwallet](myetherwallet.com) 
 7. Last step, we need to update `deploy/testnet/nodes/bin/genesis.json` by new address of validators.  
 Run `puppeth` and full fill data of your chain. Using 3 Addresses we just get from 3 Private Keys above.   
    ```shell script
    Please specify a network name to administer (no spaces, hyphens or capital letters please)
    > testnet
    
    Sweet, you can set this via --network=testnet next time!
    
    INFO [11-27|18:06:28.498] Administering Evrynet network           name=testnet
    INFO [11-27|18:06:28.501] No remote machines to gather stats from
    
    What would you like to do? (default = stats)
     1. Show network stats
     2. Configure new genesis
     3. Track new remote server
     4. Deploy network components
    > 2
    
    What would you like to do? (default = create)
     1. Create new genesis from scratch
     2. Import already existing genesis
    > 1
    
    Which consensus engine to use? (default = clique)
     1. Ethash - proof-of-work
     2. Clique - proof-of-authority
     3. Tendermint - practical-byzantine-fault-tolerance
    > 3
    How many block (Epoch) after which to checkpoint and reset the pending votes (default 30000)
    > 30000
    What is poclicy to select proposer (default 0 - roundrobin)
    > 0
    
    Which accounts are validators? (mandatory at least one)
    > 0xaddress_node_1 (Put 3 Address of nodes here)
    > 0xaddress_node_2
    > 0xaddress_node_2
    
    Which accounts should be pre-funded? (advisable at least one)
    > 0xaddress_node_1 (Put 3 Address of nodes here)
        > 0xaddress_node_2
        > 0xaddress_node_2
    
    Should the precompile-addresses (0x1 .. 0xff) be pre-funded with 1 wei? (advisable yes)
    > yes
    
    Specify your chain/network ID if you want an explicit one (default = random)
    > 15
    
    INFO [11-27|18:08:51.838] Configured new genesis block
    
    What would you like to do? (default = stats)
     1. Show network stats
     2. Manage existing genesis
     3. Track new remote server
     4. Deploy network components
    > 2
    
     1. Modify existing fork rules
     2. Export genesis configurations
     3. Remove genesis configuration
    > 2
    
    Which folder to save the genesis specs into? (default = current)
      Will create testnet.json, testnet-aleth.json, testnet-harmony.json, testnet-parity.json
    >
    INFO [11-27|18:09:06.979] Saved native genesis chain spec          path=testnet.json
    ERROR[11-27|18:09:06.980] Failed to create Aleth chain spec        err="unsupported consensus engine"
    ERROR[11-27|18:09:06.980] Failed to create Parity chain spec       err="unsupported consensus engine"
    INFO [11-27|18:09:06.981] Saved genesis chain spec                 client=harmony path=testnet-harmony.json
    ```
8. Replace all content of `deploy/testnet/nodes/bin/genesis.json` with `testnet.json` (new genesis file just created)

9. Run the deployment script or to run each node from executable:

To deploy using pre-written scripts:  
 Run this command `deploy/testnet/deploy_bootnode_nodes.sh` with the suitable params. This command can use on Testnet server:  
```shell script
$ deploy/testnet/deploy_bootnode_nodes.sh
- Path of Sharing Volume: /home/ubuntu/testnet/nodes                                            (the path to nodes folder. On Testnet is `/home/ubuntu/testnet/nodes`)
- Path of Genesis File: /home/ubuntu/evrynet-node/deploy/testnet/nodes/bin/genesis.json         (inject genesis file to the image)
- RPC Cors Domain: *                                                                            (allow URL can call API)
- Tag Version/Branch Name you want to deploy: develop                                           (a specific tag or branch you want to build (1.1.2, develop ...)) 
- Environment of Image: testnet                                                                 (use as a suffix of image tag (testnet, local, ...))
```  


 To deploy by running binary files:
- You must start the bootnode first to let nodes discover each other
```shell script
./bootnode -nodekeyhex "9dbcbd49f9f4e1b4949178d7e413142267050377ff99d81c08e371cdea712f09" -verbosity 9 -addr ":30300"
```
-nodekeyhex: you can get new value by command `./bootnode --genkey=nodekey`

- You must init data for the node first
```shell script
./gev --datadir ./data init ./deploy/testnet/nodes/bin/genesis.json
```
--datadir: where you store node data

- Then start node by this command
```shell script
./gev --datadir ./data --verbosity 4 --tendermint.blockperiod 1 --syncmode full --networkid 15 \
    --rpc --rpcaddr 0.0.0.0 --rpccorsdomain "*" --rpcvhosts "*" --rpcport 22001 --port 30301 \
    --bootnodes "enode://aa8d839e6dbe3524e8c0a62aefae7cefa3880f9c7394ddaaa31cc8679fe3a25396e014c5c48814d0fe18d7f03d72a7971fd50b7dd689bd04498d98902dd0d82f@172.25.0.100:30300" \
    --allow-insecure-unlock \
    --rpcapi admin,db,eth,debug,miner,net,shh,txpool,personal,web3 2>>./log/node_1.log
```
--bootnodes: you will see this value when you start bootnode. Change `172.25.0.100` to IP of bootnode server

- To run another node, you can reuse the above command. You must change the value of params `rpcport, port` and `node_1.log`
